<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<title>보험상품 등록/수정</title>
	<!-- CDN -->
	<link href="https://cdn.jsdelivr.net/npm/jsoneditor@9.10.0/dist/jsoneditor.min.css" rel="stylesheet" />
	<script src="https://cdn.jsdelivr.net/npm/jsoneditor@9.10.0/dist/jsoneditor.min.js"></script>

</head>
<body>
  <h2 th:text="${product.p_id == null ? '신규 등록' : '수정하기'}"></h2>

  <form method="post" th:action="@{/admin/insurance/save}">
    <input type="hidden" th:if="${product.p_id}" name="p_id" th:value="${product.p_id}" />
    
    <label>제목: <input type="text" name="title" th:value="${product.title}" /></label><br/>
    <label>뱃지: <input type="text" name="badge" th:value="${product.badge}" /></label><br/>
    <label>서브 타이틀: <input type="text" name="subtitle" th:value="${product.subtitle}" /></label><br/>
    <label>설명: <textarea name="descriptions" th:text="${product.descriptions}"></textarea></label><br/>
    <label>브레드크럼: <input type="text" name="breadcrumb" th:value="${product.breadcrumb}" /></label><br/>
    <label>메인버튼: <input type="text" name="main_button_text" th:value="${product.main_button_text}" /></label><br/>
    <label>이미지 URL: <input type="text" name="top_image" th:value="${product.top_image}" /></label><br/>

	<!-- JSON 에디터 영역 -->
	 <label>탭 목록 (JSON):</label>
	 <div id="tabsEditor" style="height: 200px; border: 1px solid #ccc;"></div>
	 <input type="hidden" name="tabs_json" id="tabs_json" />

	 <label>섹션 목록 (JSON):</label>
	 <div id="sectionsEditor" style="height: 300px; border: 1px solid #ccc;"></div>
	 <input type="hidden" name="sections_json" id="sections_json" />

	 <label>하단 버튼 목록 (JSON):</label>
	 <div id="buttonsEditor" style="height: fit-content; border: 1px solid #ccc;"></div>
	 <input type="hidden" name="bottom_buttons_json" id="bottom_buttons_json" />

    <button type="submit">저장</button>
    <a href="/admin/insurance">목록</a>	
  </form>
  
  <script>
    // 초기 데이터 (서버에서 온 JSON 문자열을 파싱)
    const initialTabs = /*[[${product.tabs_json}]]*/ '[]';
    const initialSections = /*[[${product.sections_json}]]*/ '[]';
    const initialButtons = /*[[${product.bottom_buttons_json}]]*/ '[]';

    // JSONEditor 인스턴스 생성
    const tabsEditor = new JSONEditor(document.getElementById('tabsEditor'), {
      mode: 'code',
      modes: ['code', 'tree'],
      onError: function (err) { alert(err.toString()); }
    });
    tabsEditor.set(JSON.parse(initialTabs || '[]'));

    const sectionsEditor = new JSONEditor(document.getElementById('sectionsEditor'), {
      mode: 'code',
      modes: ['code', 'tree'],
      onError: function (err) { alert(err.toString()); }
    });
    sectionsEditor.set(JSON.parse(initialSections || '[]'));

    const buttonsEditor = new JSONEditor(document.getElementById('buttonsEditor'), {
      mode: 'code',
      modes: ['code', 'tree'],
      onError: function (err) { alert(err.toString()); }
    });
    buttonsEditor.set(JSON.parse(initialButtons || '[]'));

    // 폼 제출 전에 JSON 값을 숨은 input에 넣기
    document.querySelector('form').addEventListener('submit', function (e) {
      try {
        document.getElementById('tabs_json').value = JSON.stringify(tabsEditor.get());
        document.getElementById('sections_json').value = JSON.stringify(sectionsEditor.get());
        document.getElementById('bottom_buttons_json').value = JSON.stringify(buttonsEditor.get());
      } catch (err) {
        e.preventDefault();
        alert('JSON 형식이 올바르지 않습니다:\n' + err.message);
      }
    });
  </script>

</body>
</html>
